{% extends 'base.html' %}
{% block title %}Incident #{{ incident.id }} - IncidentMgr{% endblock %}
{% block content %}

<!-- ── Header ── -->
<div class="d-flex justify-content-between align-items-start mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('incidents') }}">Incidents</a></li>
        <li class="breadcrumb-item active">#{{ incident.id }}</li>
      </ol>
    </nav>
    <h2 class="fw-bold mb-1">{{ incident.title }}</h2>
    <div>
      <span class="badge badge-{{ incident.severity }} me-1">
        {{ incident.severity.upper() }}
      </span>
      {% if incident.status == 'open' %}
        <span class="badge bg-warning text-dark">Open</span>
      {% elif incident.status == 'in_progress' %}
        <span class="badge bg-info">In Progress</span>
      {% elif incident.status == 'resolved' %}
        <span class="badge bg-success">Resolved</span>
      {% else %}
        <span class="badge bg-secondary">Closed</span>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    {% if user.role in ['admin', 'engineer'] and incident.status != 'resolved' %}
    <a href="{{ url_for('edit_incident', incident_id=incident.id) }}"
       class="btn btn-outline-secondary">
      <i class="bi bi-pencil me-1"></i>Edit
    </a>
    {% endif %}

    {% if user.role in ['admin', 'engineer'] and incident.status not in ['resolved', 'closed'] %}
    <form method="POST"
          action="{{ url_for('resolve_incident', incident_id=incident.id) }}"
          onsubmit="return confirm('Mark this incident as resolved?')">
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check-circle me-1"></i>Resolve
      </button>
    </form>
    {% endif %}
  </div>
</div>

<div class="row g-4">

  <!-- ── Left column: Description + Comments ── -->
  <div class="col-md-8">

    <!-- Description -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-file-text me-2"></i>Description
      </div>
      <div class="card-body">
        <p class="mb-0">{{ incident.description }}</p>
      </div>
    </div>

    <!-- Comments -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-chat-dots me-2"></i>Comments ({{ incident.comments|length }})
      </div>
      <div class="card-body">

        {% for comment in incident.comments %}
        <div class="d-flex mb-3">
          <div class="bg-primary text-white rounded-circle d-flex align-items-center
                      justify-content-center me-3 fw-bold"
               style="width:36px;height:36px;flex-shrink:0;font-size:.85rem;">
            {{ comment.author.username[0].upper() }}
          </div>
          <div>
            <div class="fw-semibold">
              {{ comment.author.username }}
              <span class="text-muted fw-normal" style="font-size:.8rem;">
                · {{ comment.created_at.strftime('%b %d, %Y %H:%M') }}
              </span>
            </div>
            <div>{{ comment.content }}</div>
          </div>
        </div>
        {% else %}
        <p class="text-muted">No comments yet.</p>
        {% endfor %}

        <hr/>
        <!-- Add Comment -->
        <form method="POST"
              action="{{ url_for('add_comment', incident_id=incident.id) }}">
          <div class="mb-2">
            <textarea name="content" class="form-control" rows="2"
                      placeholder="Add a comment..."></textarea>
          </div>
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="bi bi-send me-1"></i>Post Comment
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ── Right column: Metadata + Assign ── -->
  <div class="col-md-4">

    <!-- Details -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">Details</div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-5 text-muted">Reporter</dt>
          <dd class="col-7">{{ incident.creator.username }}</dd>

          <dt class="col-5 text-muted">Assigned To</dt>
          <dd class="col-7">{{ incident.assignee.username if incident.assignee else '—' }}</dd>

          <dt class="col-5 text-muted">Created</dt>
          <dd class="col-7">{{ incident.created_at.strftime('%b %d, %Y %H:%M') }}</dd>

          <dt class="col-5 text-muted">Updated</dt>
          <dd class="col-7">{{ incident.updated_at.strftime('%b %d, %Y %H:%M') }}</dd>

          {% if incident.resolved_at %}
          <dt class="col-5 text-muted">Resolved</dt>
          <dd class="col-7">{{ incident.resolved_at.strftime('%b %d, %Y %H:%M') }}</dd>
          {% endif %}
        </dl>
      </div>
    </div>

    <!-- Assign (admin only) -->
    {% if user.role == 'admin' and incident.status != 'resolved' %}
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-person-check me-2"></i>Assign Incident
      </div>
      <div class="card-body">
        <form method="POST"
              action="{{ url_for('assign_incident', incident_id=incident.id) }}">
          <div class="mb-2">
            <select name="engineer_id" class="form-select form-select-sm">
              <option value="">Select Engineer...</option>
              {% for eng in engineers %}
              <option value="{{ eng.id }}"
                {% if incident.assigned_to == eng.id %}selected{% endif %}>
                {{ eng.username }} ({{ eng.role }})
              </option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-sm btn-primary w-100">
            <i class="bi bi-person-check me-1"></i>Assign
          </button>
        </form>
      </div>
    </div>
    {% endif %}

  </div>
</div>

{% endblock %}